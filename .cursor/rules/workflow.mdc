---
description: Workflow (global) — commandes essentielles, tests, déploiement, venv
globs: []
alwaysApply: true
---

- **Environnement virtuel Python** :
  - Le projet utilise un venv (`.venv/`) pour isoler les dépendances Python
  - Tous les scripts npm utilisent automatiquement le venv (pas d'activation manuelle nécessaire)
  - Installation : `npm run setup` (créer venv + installer dépendances)
  - Vérification : `npm run verify:venv` (vérifier que le venv est correctement configuré)
  - Activation manuelle (si besoin) : `.\scripts\activate-venv.ps1` ou `.\.venv\Scripts\Activate.ps1`

- **Commandes essentielles (donner en une ligne)** :
  - Installation initiale : `npm run setup` (créer venv + installer toutes les dépendances)
  - Développement : `npm run dev` (lance backend sur 4243 + frontend sur 3000 automatiquement, utilise venv)
  - Développement avec nettoyage cache : `npm run dev:clean` (nettoie cache Vite avant démarrage, utile si changements non visibles)
  - Vérification processus/ports : `npm run dev:check` (détecte processus zombies, ports bloqués, lockfile stale. Ajouter `--clean` pour nettoyage automatique)
  - Statut services : `npm run dev:status` (affiche statut backend/frontend en tableau formaté)
  - Arrêt services : `npm run dev:stop` (arrête proprement tous les services)
  - Tests : `npm test` ou `pytest tests/` (utilise automatiquement le venv)
  - Build production : `npm run deploy:build`
  - Vérification déploiement : `npm run deploy:check`

- **Quand du code a changé** :
  - **Backend Python** : `npm test` ou `pytest tests/` (utilise automatiquement le venv)
    - Tests API : `npm run test:api` ou `pytest tests/api/` (utilise TestClient FastAPI, pas besoin de serveur)
    - Tests unitaires : `pytest tests/ -k "not api"`
  - **Frontend React** : `npm run test:frontend` (build + lint + tests unitaires)
    - Build check détecte erreurs TypeScript
    - Lint check détecte erreurs de code
    - Tests Vitest vérifient les composants
  - **Interface web (PRINCIPALE)** : `npm run dev` (démarre tout sur localhost:3000, utilise venv automatiquement)

- **Tests** :
  - Commande standard : `npm test` (utilise automatiquement le venv pour pytest)
  - Alternative : `pytest tests/` (si venv activé) ou `.\scripts\run_tests.ps1` (utilise venv automatiquement)
  - Tests API : utiliser `TestClient` de FastAPI, pas de serveur réel
  - Mocks : `pytest-mock` pour services externes (LLM, fichiers GDD)
  - Configuration : `pytest.ini` définit les options (asyncio_mode, testpaths, etc.)

- **Avant commit** : `npm test` (backend, utilise venv) + `npm run test:frontend` (frontend). Si vert : commit + push.

- **Déploiement** : `npm run deploy:build` puis uploader + configurer `ENVIRONMENT=production` et `CORS_ORIGINS`.

- **Diagnostic développement** :
  - Si ports bloqués ou processus zombies : `npm run dev:check` (vérifie ports 3000/4243, processus liés au projet, lockfile)
  - Nettoyage automatique : `npm run dev:check --clean` (arrête processus zombies, supprime lockfile stale)
  - Voir statut : `npm run dev:status` (tableau formaté avec health checks)
  - Vérifier venv : `npm run verify:venv` (vérifie que le venv et les dépendances sont OK)
  - Script de vérification : `scripts/dev-check.js` (détecte automatiquement processus liés au projet vs autres)

- **Problèmes courants** :
  - "Python non trouvé" ou "module non trouvé" : Exécuter `npm run setup` pour créer/réparer le venv
  - Dépendances manquantes : `npm run verify:venv` puis `npm run setup` si nécessaire
  - Venv corrompu : Supprimer `.venv/` puis `npm run setup`

