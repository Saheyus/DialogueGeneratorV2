{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://alteir.game/dialogue-format.schema.json",
  "title": "Alteir Dialogue JSON Format",
  "description": "Format JSON pour les dialogues du jeu Alteir. Format racine : tableau de nœuds.",
  "version": "1.0.0",
  "type": "array",
  "items": {
    "type": "object",
    "title": "Dialogue Node",
    "description": "Un nœud de dialogue représentant une ligne de dialogue ou un point de décision.",
    "required": [
      "id"
    ],
    "properties": {
      "id": {
        "type": "string",
        "description": "Identifiant unique du nœud (SCREAMING_SNAKE_CASE). Obligatoire. Exemples : START, END, NODE_NAME, NODE_SUCCESS, NODE_FAILURE.",
        "pattern": "^[A-Z][A-Z0-9_]*$",
        "examples": [
          "START",
          "END",
          "GREETING",
          "CHOICE_1_SUCCESS"
        ]
      },
      "speaker": {
        "type": "string",
        "description": "ID du personnage qui parle (CHARACTER_ID). Optionnel mais recommandé.",
        "examples": [
          "NPC_1",
          "Player",
          "Narrator"
        ]
      },
      "line": {
        "type": "string",
        "description": "Texte du dialogue à afficher. Optionnel mais recommandé.",
        "examples": [
          "Bonjour, voyageur !",
          "Que voulez-vous ?"
        ]
      },
      "nextNode": {
        "type": "string",
        "description": "ID du nœud suivant (si pas de choix). Ignoré si choices est présent.",
        "examples": [
          "NEXT_NODE",
          "END"
        ]
      },
      "choices": {
        "type": "array",
        "description": "Liste des choix disponibles pour ce nœud. Si présent, nextNode est ignoré.",
        "items": {
          "type": "object",
          "title": "Dialogue Choice",
          "description": "Un choix disponible dans un nœud de dialogue.",
          "required": [
            "text",
            "targetNode"
          ],
          "properties": {
            "text": {
              "type": "string",
              "description": "Texte du choix affiché au joueur. Obligatoire.",
              "examples": [
                "Accepter",
                "Refuser",
                "(Partir)"
              ]
            },
            "targetNode": {
              "type": "string",
              "description": "ID du nœud cible lorsque ce choix est sélectionné. Obligatoire.",
              "examples": [
                "ACCEPT",
                "REFUSE",
                "END"
              ]
            },
            "traitRequirements": {
              "type": "array",
              "description": "Liste des exigences de traits pour débloquer ce choix. Optionnel.",
              "items": {
                "type": "object",
                "title": "Trait Requirement",
                "description": "Exigence de trait pour débloquer un choix.",
                "required": [
                  "trait",
                  "minValue"
                ],
                "properties": {
                  "trait": {
                    "type": "string",
                    "description": "Nom du trait requis (ex: \"Courageux\", \"Diplomate\", \"Lâche\", \"Provocateur\"). Obligatoire.",
                    "examples": [
                      "Courageux",
                      "Diplomate",
                      "Lâche",
                      "Provocateur"
                    ]
                  },
                  "minValue": {
                    "type": "integer",
                    "description": "Valeur minimum requise pour ce trait. Obligatoire.",
                    "minimum": -100,
                    "maximum": 100,
                    "examples": [
                      5,
                      10,
                      -5
                    ]
                  }
                }
              },
              "minItems": 1
            },
            "allowInfluenceForcing": {
              "type": "boolean",
              "description": "Si true, permet de forcer le choix via l'influence même si les traits ne sont pas satisfaits. Optionnel, défaut: false.",
              "default": false
            },
            "influenceThreshold": {
              "type": "integer",
              "description": "Seuil d'influence minimum requis pour forcer ce choix. Optionnel, défaut: 0.",
              "default": 0,
              "minimum": 0
            },
            "influenceDelta": {
              "type": "integer",
              "description": "Modification de l'influence appliquée lors de la sélection de ce choix. Optionnel, défaut: 0.",
              "default": 0
            },
            "respectDelta": {
              "type": "integer",
              "description": "Modification du respect appliquée lors de la sélection de ce choix. Optionnel, défaut: 0.",
              "default": 0
            },
            "test": {
              "type": "string",
              "description": "Test de caractéristique au niveau du choix. Format: \"AttributeType+SkillId:DD\" (ex: \"Raison+Logique:8\"). Si présent, exécuté immédiatement lors de la sélection. Optionnel.",
              "pattern": "^[A-Za-z]+\\+[A-Za-z]+:\\d+$",
              "examples": [
                "Raison+Logique:8",
                "Puissance+Combat:5"
              ]
            },
            "testCriticalSuccessNode": {
              "type": "string",
              "description": "ID du nœud à afficher si le test du choix réussit de manière critique (score >= DD + 5). Optionnel, fallback vers testSuccessNode si non défini.",
              "examples": [
                "CHOICE_CRITICAL_SUCCESS",
                "NEXT"
              ]
            },
            "testSuccessNode": {
              "type": "string",
              "description": "ID du nœud à afficher si le test du choix réussit (score >= DD et < DD + 5). Optionnel si testCriticalSuccessNode est défini.",
              "examples": [
                "CHOICE_SUCCESS",
                "NEXT"
              ]
            },
            "testFailureNode": {
              "type": "string",
              "description": "ID du nœud à afficher si le test du choix échoue (score >= DD - 5 et < DD). Optionnel si testCriticalFailureNode est défini.",
              "examples": [
                "CHOICE_FAILURE",
                "FALLBACK"
              ]
            },
            "testCriticalFailureNode": {
              "type": "string",
              "description": "ID du nœud à afficher si le test du choix échoue de manière critique (score < DD - 5). Optionnel, fallback vers testFailureNode si non défini.",
              "examples": [
                "CHOICE_CRITICAL_FAILURE",
                "FALLBACK"
              ]
            },
            "condition": {
              "type": "string",
              "description": "Condition de flag pour afficher/masquer le choix. Format: \"FLAG_NAME\" ou \"NOT FLAG_NAME\". Si présent, le choix n'est affiché que si la condition est satisfaite. Optionnel.",
              "pattern": "^(NOT )?[A-Z][A-Z0-9_]*$",
              "examples": [
                "FLAG_COMPLETED",
                "NOT FLAG_LOCKED"
              ]
            }
          }
        },
        "minItems": 1,
        "maxItems": 4
      },
      "test": {
        "type": "string",
        "description": "Test de caractéristique au niveau du nœud. Format: \"AttributeType+SkillId:DD\" (ex: \"Raison+Logique:8\"). Si présent, redirige selon le palier de résultat (criticalSuccessNode, successNode, failureNode, criticalFailureNode).",
        "pattern": "^[A-Za-z]+\\+[A-Za-z]+:\\d+$",
        "examples": [
          "Raison+Logique:8",
          "Puissance+Combat:5"
        ]
      },
      "criticalSuccessNode": {
        "type": "string",
        "description": "ID du nœud à afficher si le test réussit de manière critique (score >= DD + 5). Optionnel, fallback vers successNode si non défini.",
        "examples": [
          "TEST_CRITICAL_SUCCESS",
          "NEXT"
        ]
      },
      "successNode": {
        "type": "string",
        "description": "ID du nœud à afficher si le test réussit (score >= DD et < DD + 5). Optionnel si criticalSuccessNode est défini.",
        "examples": [
          "TEST_SUCCESS",
          "NEXT"
        ]
      },
      "failureNode": {
        "type": "string",
        "description": "ID du nœud à afficher si le test échoue (score >= DD - 5 et < DD). Optionnel si criticalFailureNode est défini.",
        "examples": [
          "TEST_FAILURE",
          "FALLBACK"
        ]
      },
      "criticalFailureNode": {
        "type": "string",
        "description": "ID du nœud à afficher si le test échoue de manière critique (score < DD - 5). Optionnel, fallback vers failureNode si non défini.",
        "examples": [
          "TEST_CRITICAL_FAILURE",
          "FALLBACK"
        ]
      },
      "isLongRest": {
        "type": "boolean",
        "description": "Si true, déclenche un repos long (récupération complète des Points d'Effort). Optionnel, défaut: false.",
        "default": false
      },
      "startState": {
        "type": "integer",
        "description": "Identifiant d'état pour les nœuds de démarrage. Utilisé pour les dialogues avec plusieurs points d'entrée selon le contexte. Optionnel, défaut: 0.",
        "default": 0,
        "minimum": 0
      },
      "cutsceneMode": {
        "type": "boolean",
        "description": "Active le mode cutscene pour ce nœud. Optionnel, défaut: false.",
        "default": false
      },
      "cutsceneImageId": {
        "type": "string",
        "description": "ID de l'image de cutscene à afficher. Optionnel.",
        "examples": [
          "scene_1",
          "portrait_npc"
        ]
      },
      "cutsceneId": {
        "type": "string",
        "description": "ID de la cutscene à déclencher. Optionnel.",
        "examples": [
          "cutscene_intro",
          "cutscene_ending"
        ]
      },
      "exitCutsceneMode": {
        "type": "boolean",
        "description": "Sort du mode cutscene. Optionnel, défaut: false.",
        "default": false
      },
      "consequences": {
        "type": "object",
        "description": "Conséquences du nœud (flags narratifs). Optionnel.",
        "properties": {
          "flag": {
            "type": "string",
            "description": "Flag narratif à définir (ex: \"CADRAN_EMPORTE\", \"GANTELET_DETRUIT\"). Obligatoire.",
            "pattern": "^[A-Z][A-Z0-9_]*$",
            "examples": [
              "CADRAN_EMPORTE",
              "GANTELET_DETRUIT",
              "QUEST_COMPLETED"
            ]
          },
          "description": {
            "type": "string",
            "description": "Description optionnelle de la conséquence (pour debug/documentation). Optionnel.",
            "examples": [
              "Le joueur a emporté le cadran",
              "Le gantelet a été détruit"
            ]
          }
        },
        "required": [
          "flag"
        ]
      }
    }
  },
  "minItems": 1,
  "examples": [
    [
      {
        "id": "START",
        "speaker": "Personnage",
        "line": "Bonjour !",
        "choices": [
          {
            "text": "Répondre",
            "targetNode": "REPLY"
          }
        ]
      }
    ]
  ]
}